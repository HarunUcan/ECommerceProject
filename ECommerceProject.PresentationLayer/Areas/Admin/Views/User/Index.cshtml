@model List<AppUserDto>
@{
    ViewData["Title"] = "Kullanıcılar";
    ViewData["ActivePage"] = "Users";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-semibold text-gray-700">Kullanıcılar</h1>

        <!-- Arama Kutucuğu -->
        <div class="relative">
            <input type="text" id="userSearchInput" placeholder="Kullanıcı ara..."
                   class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" />
            <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
                 xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M21 21l-4.35-4.35m2.44-5.14a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>

            <div id="searchResults" class="absolute z-50 mt-1 w-full bg-white border border-gray-300 rounded shadow-lg hidden">
                <!-- AJAX sonuçları buraya gelecek -->
            </div>
        </div>
    </div>
    <!-- User List -->
    <div class="bg-gray-50 p-8 rounded-lg shadow-md">

        <!-- Arama Kutucuğu -->
        @* <div class="relative w-72">
            <input id="userSearchInput" type="text" placeholder="Kullanıcı ara..."
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring focus:border-blue-300" />

            <div id="searchResults" class="absolute z-50 mt-1 w-full bg-white border border-gray-300 rounded shadow-lg hidden">
                <!-- AJAX sonuçları buraya gelecek -->
            </div>
        </div> *@

        <div class="flex justify-between">
            <h2 class="text-xl font-semibold text-gray-700 mb-6">Kullanıcı Listesi</h2>

            <div class="flex justify-end mb-4 gap-2">
                <button id="deleteSelectedBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">Seçilenleri Sil</button>
                <button id="sendMailBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Seçilenlere Mail Gönder</button>
            </div>
        </div>
        

        <table class="w-full table-auto border-collapse">
            <thead>
                <tr>
                    <th class="border-b-2 py-4 text-left text-gray-600">
                        <input type="checkbox" id="selectAll" />
                    </th>
                    <th class="border-b-2 py-4 text-left text-gray-600">Ad Soyad</th>
                    <th class="border-b-2 py-4 text-left text-gray-600">E-Posta</th>
                    <th class="border-b-2 py-4 text-left text-gray-600">Telefon</th>
                    <th class="border-b-2 py-4 text-left text-gray-600">Rol</th>
                    <th class="border-b-2 py-4 text-left text-gray-600">Durum</th>
                    <th class="border-b-2 py-4 text-left text-gray-600">İşlemler</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model)
                {
                    <tr>
                        <td class="border-b py-4">
                            <input type="checkbox" class="user-checkbox" value="@user.Id" />
                        </td>
                        <td class="border-b py-4">@user.Name @user.Surname</td>
                        <td class="border-b py-4">@user.Email</td>
                        <td class="border-b py-4">@user.PhoneNumber</td>
                        <td class="border-b py-4">
                            <div class="relative">
                                <select onchange="changeUserRole('@user.Id', this.value)"
                                        class="appearance-none pr-6 py-1 bg-transparent cursor-pointer font-medium text-sm
                                            @(user.Role == "Admin" ? "text-blue-600" : "text-gray-800")">
                                                            <option value="Admin" selected="@(user.Role == "Admin")">Admin</option>
                                                            <option value="User" selected="@(user.Role == "User")">User</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-1 text-gray-500">
                                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                            </div>
                        </td>

                        <td class="border-b py-4">
                            @if (user.IsActive)
                            {
                                <div class="flex items-center">
                                    <span class="bg-green-500 text-white px-2 font-semibold text-sm rounded-xl">Aktif</span>
                                    <a asp-area="Admin" asp-controller="User" asp-action="ChangeStatus" asp-route-id="@user.Id" title="Değiştir">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="size-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5 7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" />
                                        </svg>
                                    </a>
                                </div>
                            }
                            else
                            {
                                <div class="flex items-center">
                                    <span class="bg-red-500 text-white px-2 font-semibold text-sm rounded-xl">Pasif</span>
                                    <a asp-area="Admin" asp-controller="User" asp-action="ChangeStatus" asp-route-id="@user.Id" title="Değiştir">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="size-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5 7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" />
                                        </svg>
                                    </a>
                                </div>
                            }
                        </td>

                        <td class="border-b py-4">
                            <a href="/kullanici-duzenle/@user.Id"
                               class="text-yellow-600 hover:text-yellow-800 transition" title="Düzenle"><i class="fas fa-edit"></i></a>
                            <button onclick="confirmDelete(@user.Id)" class="text-red-600 hover:text-red-800 transition" title="Sil"><i class="fa-solid fa-trash-can"></i></button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<script>
    document.getElementById('selectAll').addEventListener('change', function () {
        document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = this.checked);
    });

    document.getElementById('deleteSelectedBtn').addEventListener('click', function () {
        const selectedIds = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);
        if (selectedIds.length === 0) {
            Swal.fire("Uyarı", "Lütfen silmek için kullanıcı seçin.", "warning");
            return;
        }

        Swal.fire({
            title: "Emin misiniz?",
            text: "Seçilen kullanıcılar silinecek!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "Evet, sil!",
            cancelButtonText: "İptal"
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = `/Admin/User/DeleteMultiple?ids=${selectedIds.join(",")}`;
            }
        });
    });

    document.getElementById('sendMailBtn').addEventListener('click', function () {
        const selectedIds = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);
        if (selectedIds.length === 0) {
            Swal.fire("Uyarı", "Lütfen mail göndermek için kullanıcı seçin.", "warning");
            return;
        }

        window.location.href = `/Admin/User/SendMailToUsers?ids=${selectedIds.join(",")}`;
    });

    function changeUserRole(userId, newRole) {
        fetch(`/Admin/User/ChangeRole`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ id: userId, role: newRole })
        })
        .then(response => {
            if (response.ok) {
                Swal.fire("Başarılı", "Kullanıcı rolü güncellendi.", "success");
            } else {
                throw new Error("Güncellenemedi");
            }
        })
        .catch(() => Swal.fire("Hata", "Rol değiştirilemedi.", "error"));
    }

    function confirmDelete(userId) {
        Swal.fire({
            title: "Emin misiniz?",
            text: "Bu kullanıcıyı silmek istediğinize emin misiniz?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "Evet, sil!",
            cancelButtonText: "İptal"
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = `/Admin/User/Delete?id=${userId}`;
            }
        });
    }


    // Kullanıcı Arama İşlemleri
    const searchInput = document.getElementById("userSearchInput");
    const resultsDiv = document.getElementById("searchResults");
    let timeout = null;

    searchInput.addEventListener("keyup", function () {
        clearTimeout(timeout);
        const query = this.value.trim();

        if (query.length < 2) {
            resultsDiv.classList.add("hidden");
            resultsDiv.innerHTML = "";
            return;
        }

        timeout = setTimeout(() => {
            fetch(`/Admin/User/SearchUsers?term=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.length === 0) {
                        resultsDiv.innerHTML = `<div class="px-4 py-2 text-sm text-gray-500">Kullanıcı bulunamadı.</div>`;
                    } else {
                        resultsDiv.innerHTML = data.map(user => `
                                <a href="/kullanici-duzenle/${user.id}" class="block px-4 py-2 hover:bg-gray-100 text-sm text-gray-800">
                                    ${user.name} ${user.surname} <br><span class="text-gray-500 text-xs">${user.email}</span>
                                </a>
                            `).join("");
                    }
                    resultsDiv.classList.remove("hidden");
                })
                .catch(err => {
                    console.error("Arama hatası:", err);
                    resultsDiv.classList.add("hidden");
                });
        }, 300); // debounce
    });

    // Arama kutusunun dışına tıklanınca kapat
    document.addEventListener("click", function (e) {
        if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
            resultsDiv.classList.add("hidden");
        }
    });
</script>
