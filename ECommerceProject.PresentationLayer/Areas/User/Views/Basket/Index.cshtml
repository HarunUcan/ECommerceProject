@model HomeViewModel
@{
    ViewData["Title"] = "Index";
    Layout = "~/Areas/User/Views/Shared/_Layout.cshtml";
}
@{
    decimal totalPrice = 0;
    foreach (var basketItem in Model.Basket.BasketItems)
    {
        if(basketItem.Product.DiscountRate != null && basketItem.Product.DiscountRate > 0)
        {
            decimal discountedPrice = basketItem.Product.Price - (basketItem.Product.Price * (basketItem.Product.DiscountRate.Value / 100));
            totalPrice += discountedPrice * basketItem.Quantity;
        }
        else if(basketItem.Product.DiscountAmount != null && basketItem.Product.DiscountAmount > 0)
        {
            decimal discountedPrice = basketItem.Product.Price - basketItem.Product.DiscountAmount.Value;
            totalPrice += discountedPrice * basketItem.Quantity;
        }
        else
        {
            totalPrice += basketItem.Product.Price * basketItem.Quantity;
        }
    }
    // totalPrice += basketItem.Product.Price * basketItem.Quantity;

    decimal kdv = totalPrice * 0.1m; // KDV oranı %10

    decimal discountedProductPrice = 0m;

}

@{
    decimal subtotal = totalPrice - kdv;
    decimal basketDiscountTotal = 0;

    if (Model.Basket.BasketCoupons != null && Model.Basket.BasketCoupons.Any())
    {
        foreach (var basketCoupon in Model.Basket.BasketCoupons)
        {
            var coupon = basketCoupon.Coupon;

            if (coupon.DiscountAmount.HasValue)
            {
                basketDiscountTotal += coupon.DiscountAmount.Value;
            }
            else if (coupon.DiscountPercentage.HasValue)
            {
                basketDiscountTotal += (totalPrice * coupon.DiscountPercentage.Value / 100);
            }
        }
    }

    var finalTotal = totalPrice - basketDiscountTotal;
}

<head>
    <script>
        function increaseQuantity(inputId) {
            const input = document.getElementById(inputId);
            input.value = parseInt(input.value) + 1;
        }

        function decreaseQuantity(inputId) {
            const input = document.getElementById(inputId);
            if (parseInt(input.value) > 1) {
                input.value = parseInt(input.value) - 1;
            }
        }

    </script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
        }

        h1,
        h2,
        h3 {
            font-family: 'Playfair Display', serif;
        }

        .quantity-input {
            display: flex;
            align-items: center;
            /* border: 2px solid #333; */
            padding: 5px 10px;
            border-radius: 8px;
        }

        .quantity-input input {
            width: 40px;
            text-align: center;
            font-size: 16px;
        }

        @@layer base {

            input[type="number"]::-webkit-inner-spin-button,
            input[type="number"]::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
        }

        textarea:focus,
        input:focus {
            outline: none;
        }
    </style>
</head>

<!-- Sepet İçeriği -->
<main class="container mx-auto px-4 py-8 flex-1">
    <h1 class="text-2xl font-bold mb-8 text-left">Sepet</h1>
    <div class="flex flex-col md:flex-row gap-8">
        <!-- Sepet Tablosu -->
        <div class="flex-1 overflow-x-auto">
            <table class="w-full border-collapse border-spacing-0 hidden sm:table">
                <thead class="border-b">
                    <tr>
                        <th class="text-left py-3 font-semibold">ÜRÜN</th>
                        <th class="text-left py-3 font-semibold hidden sm:table-cell">BİRİM FİYAT</th>
                        <th class="text-left py-3 font-semibold">ADET</th>
                        <th class="text-left py-3 font-semibold hidden sm:table-cell">TOPLAMI</th>
                        <th class="text-left py-3"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach(var basketItem in Model.Basket.BasketItems)
                    {
                        <!-- Ürün Satırı -->
                        <tr class="border-b">
                            <td class="py-4 flex items-center space-x-4">
                                <img src="@basketItem.Product.ProductImages.FirstOrDefault().Url.Replace("wwwroot","")" alt="Ürün 1"
                                     class="w-16 h-16 rounded object-cover min-w-[64px] min-h-[64px] object-top">
                                <div>
                                    <div class="font-semibold">@basketItem.Product.Name</div>
                                    <div class="text-sm text-gray-500">067153-70722</div>
                                    <div class="text-sm text-gray-500">Beden: @basketItem.Size</div>
                                </div>
                            </td>

                            <!-- Birim Fİyat -->
                            <td class="py-4 hidden sm:table-cell">
                                <div>
                                    @if (basketItem.Product.DiscountRate != null && basketItem.Product.DiscountRate > 0)
                                    {
                                        discountedProductPrice = basketItem.Product.Price - (basketItem.Product.Price * (basketItem.Product.DiscountRate.Value / 100));
                                        <div class="line-through text-red-500 text-sm">₺@basketItem.Product.Price</div>
                                        <div>₺@(discountedProductPrice.ToString("F2"))</div>
                                    }
                                    else if (basketItem.Product.DiscountAmount != null && basketItem.Product.DiscountAmount > 0)
                                    {
                                        discountedProductPrice = basketItem.Product.Price - basketItem.Product.DiscountAmount.Value;
                                        <div class="line-through text-red-500 text-sm">₺@basketItem.Product.Price</div>
                                        <div>₺@(discountedProductPrice.ToString("F2"))</div>
                                    }
                                    else
                                    {
                                        discountedProductPrice = basketItem.Product.Price;
                                        <div>₺@basketItem.Product.Price</div>
                                    }
                                </div>
                            </td>
                            <td class="py-4">

                                <div class="flex justify-center items-center quantity-input w-24">
                                    <button class="flex justify-center items-center bg-gray-50 w-[28px] text-lg rounded-full transition ease-in-out hover:bg-gray-300 duration-300">
                                        -
                                    </button>
                                    <input type="number" class="outline-none bg-gray-50" value="@basketItem.Quantity" min="1">
                                    <button class="flex justify-center items-center bg-gray-50 w-[28px] text-lg rounded-full transition ease-in-out hover:bg-gray-300 duration-300">
                                        +
                                    </button>
                                </div>
                            </td>

                            <!-- Toplam Fİyat -->
                            <td class="py-4 hidden sm:table-cell">₺@((discountedProductPrice * basketItem.Quantity).ToString("F2"))</td>
                            <td class="py-4">
                                <a asp-controller="Basket" asp-action="DeleteProductFromBasket" asp-route-productId="@basketItem.ProductId" asp-route-size="@basketItem.Size">
                                    <i class="fa-solid fa-trash-can text-red-500 mr-2"></i>
                                </a>
                            </td>
                        </tr>
                    }

                </tbody>
            </table>

            @foreach (var basketItem in Model.Basket.BasketItems)
            {
                <!-- Mobil Görünüm Ürün Kartı -->
                <div class="border border-gray-400 pt-2 pb-8 mb-3 rounded-lg sm:hidden">

                    <div class="flex justify-between p-3">
                        <img src="@basketItem.Product.ProductImages.FirstOrDefault().Url.Replace("wwwroot","")" alt=""
                             class="w-24 h-24 rounded object-cover min-w-[64px] min-h-[64px] object-top">
                        <div class="ml-2">
                            <div class="font-semibold">@basketItem.Product.Name</div>
                            <div class="text-sm text-gray-500 pt-1">Ürün Kodu: 067153-70722</div>
                            <div class="text-sm text-gray-500 pt-1">Beden: @basketItem.Size</div>
                            @* <div class="text-xs text-red-500 pt-1 line-through">₺329,99</div> *@ <!-- İndirim Alanı -->
                            <div class="text-sm text-gray-500 ">
                                @if (basketItem.Product.DiscountRate != null && basketItem.Product.DiscountRate > 0)
                                {
                                    discountedProductPrice = basketItem.Product.Price - (basketItem.Product.Price * (basketItem.Product.DiscountRate.Value / 100));
                                    <div class="line-through text-red-500 text-xs">₺@basketItem.Product.Price</div>
                                    <div>₺@(discountedProductPrice.ToString("F2"))</div>
                                }
                                else if (basketItem.Product.DiscountAmount != null && basketItem.Product.DiscountAmount > 0)
                                {
                                    discountedProductPrice = basketItem.Product.Price - basketItem.Product.DiscountAmount.Value;
                                    <div class="line-through text-red-500 text-xs">₺@basketItem.Product.Price</div>
                                    <div>₺@(discountedProductPrice.ToString("F2"))</div>
                                }
                                else
                                {
                                    discountedProductPrice = basketItem.Product.Price;
                                    <div>₺@basketItem.Product.Price</div>
                                }
                            </div>
                        </div>
                        <div class="">
                            <a asp-controller="Basket" asp-action="DeleteProductFromBasket" asp-route-productId="@basketItem.ProductId" asp-route-size="@basketItem.Size">
                                <i class="fa-solid fa-trash-can text-red-500 mr-2"></i>
                            </a>
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <div class="quantity-input w-24 ml-3">
                            <button class="flex justify-center items-center bg-gray-50 w-[28px] text-lg rounded-full transition ease-in-out hover:bg-gray-300 duration-300">
                                -
                            </button>
                            <input type="number" class="outline-none bg-gray-50" value="@basketItem.Quantity" min="1">
                            <button class="flex justify-center items-center bg-gray-50 w-[28px] text-lg rounded-full transition ease-in-out hover:bg-gray-300 duration-300">
                                +
                            </button>
                        </div>

                        <div class="text-sm text-gray-1000 mr-8">Toplam: ₺@((discountedProductPrice * basketItem.Quantity).ToString("F2"))</div>
                    </div>


                </div>
            }

            
        </div>
        

        <!-- Sipariş Özeti -->
        <div class="bg-gray-100 px-6 pt-8 pb-4 shadow-md rounded-lg w-full h-full md:w-1/3 sticky top-[150px] self-start">
            <h2 class="text-xl font-semibold mb-4">Sipariş Özeti</h2>

            <div class="flex justify-between mb-2">
                <span>Ara Toplam:</span>
                <span>₺@subtotal.ToString("0.00")</span>
            </div>

            <div class="flex justify-between mb-2">
                <span>KDV (%10):</span>
                <span>₺@kdv.ToString("0.00")</span>
            </div>

            <div class="flex justify-between mb-2">
                <span>Kargo:</span>
                <span>Ücretsiz</span>
            </div>

            @if (basketDiscountTotal > 0)
            {
                <div class="flex justify-between text-green-700 font-medium mb-2">
                    <span>İndirim:</span>
                    <span>-₺@basketDiscountTotal.ToString("0.00")</span>
                </div>
            }

            <hr class="my-2 h-px bg-gray-300 border-0" />

            <div class="flex justify-between font-bold text-lg">
                <span>Toplam:</span>
                <span>₺@finalTotal.ToString("0.00")</span>
            </div>

            <!-- Kupon Alanı ve Listelemesi -->
            <div class="mt-4 flex justify-center">
                <button id="discount-button" class="font-semibold hover:underline text-gray-800 py-2 rounded">
                    Kupon Kodu +
                </button>

                <div id="coupon-section" class="hidden my-4 w-full">
                    <form asp-controller="Basket" asp-action="ApplyCoupon" method="post" class="flex gap-2">
                        <input type="text" id="coupon-code" name="couponCode"
                               class="w-full border-b bg-transparent h-8 px-2 border-gray-400 shadow-sm focus:border-gray-500 sm:text-sm"
                               placeholder="Kupon kodunuzu girin" />
                        <button type="submit"
                                class="px-4 bg-green-700 font-semibold text-white rounded h-8 hover:bg-green-800">
                            Uygula
                        </button>
                    </form>
                    <p id="coupon-message" class="text-sm text-green-600 mt-2 hidden">Kupon başarıyla uygulandı!</p>
                    <p id="error-message" class="text-sm text-red-600 mt-2 hidden">Geçersiz kupon kodu.</p>
                </div>
            </div>

            @* Kupon kodu uygulandıktan sonra varsa hata mesajı *@
            <div asp-validation-summary="ModelOnly" class="text-red-500 text-sm mb-2"></div>


            @if (Model.Basket.BasketCoupons != null && Model.Basket.BasketCoupons.Any())
            {
                <div class="mt-4">
                    <h3 class="text-md font-semibold mb-2">Aktif Kuponlar</h3>
                    <div class="flex flex-wrap gap-2">
                        @foreach (var basketCoupon in Model.Basket.BasketCoupons)
                        {
                            var coupon = basketCoupon.Coupon;
                            <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full flex items-center">
                                <span class="mr-2">@coupon.Code</span>
                                <form asp-controller="Basket" asp-action="RemoveCouponFromBasket" method="post" class="inline">
                                    <input type="hidden" name="couponCode" value="@coupon.Code" />
                                    <button type="submit" class="text-red-500 hover:text-red-700 ml-1">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>
                                </form>
                            </div>
                        }
                    </div>
                </div>
            }

            <a asp-controller="Payment" asp-action="Index" class="block text-center w-full bg-black text-white py-2 mt-4 rounded hover:bg-gray-800">
                Satın Al
            </a>

            <div class="flex justify-center font-bold mt-3 gap-x-1">
                <i class="fa-brands fa-cc-mastercard"></i>
                <i class="fa-brands fa-cc-visa"></i>
                <i class="fa-brands fa-paypal"></i>
            </div>
        </div>


    </div>
</main>

<script>

    @*"İndirim Kodu" butonuna tıklandığında kod alanını göster*@
    document.getElementById('discount-button').addEventListener('click', () => {
        const couponSection = document.getElementById('coupon-section');
        couponSection.classList.toggle('hidden'); // Alanı görünür yap veya gizle
        document.getElementById('discount-button').classList.toggle('hidden'); // Butonu gizle
    });

    // document.getElementById('apply-coupon').addEventListener('click', function () {
    //     const couponCode = document.getElementById('coupon-code').value.trim();
    //     if (couponCode !== "") {
    //         // GET isteği atıp sayfayı yönlendir
    //         window.location.href = `/User/Basket/ApplyCoupon?couponCode=${encodeURIComponent(couponCode)}`;
    //     }
    // });
</script>

